<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>HugMe - 메인</title>
    <link rel="stylesheet" href="/css/style.css"/>
</head>
<body>
<div class="main-container" id="mainContent" style="display: none;">
    <div class="welcome-section">
        <h1>🤗 HugMe</h1>
        <p>환영합니다!</p>
        <span class="status-badge status-active">로그인 중</span>
    </div>

    <div class="user-info">
        <h3>📋 사용자 정보</h3>
        <div class="info-item">
            <strong>사용자 ID:</strong>
            <span id="userIdDisplay">로딩 중...</span>
        </div>
        <div class="info-item">
            <strong>로그인 시간:</strong>
            <span id="loginTime"></span>
        </div>
    </div>

    <div class="token-section">
        <h4>🔐 Access Token</h4>
        <div class="token-display" id="accessTokenDisplay">
            토큰 로딩 중...
        </div>
    </div>

    <div class="token-section" style="border-left-color: #2196f3; background: #e3f2fd;">
        <h4 style="color: #1565c0;">🔄 Refresh Token</h4>
        <div class="token-display" id="refreshTokenDisplay">
            토큰 로딩 중...
        </div>
    </div>

    <div class="action-buttons">
        <button class="btn btn-primary" onclick="testApi()">API 테스트</button>
        <button class="btn btn-secondary" onclick="reissueTokens()">토큰 재발급</button>
        <button class="btn btn-danger" onclick="logout()">로그아웃</button>
    </div>

    <div id="errorMessage"></div>
</div>

<div class="loading" id="loadingMessage">
    <h2>🔍 인증 확인 중...</h2>
    <p>잠시만 기다려주세요.</p>
</div>
<script>
    let userId = null;

    // 페이지 로드 시 실행
    window.onload = async function() {
        console.log('페이지 로드됨');
        await verifyAuthentication();
    };

    // 인증 확인 함수
    async function verifyAuthentication() {
        const accessToken = localStorage.getItem('accessToken');
        const refreshToken = localStorage.getItem('refreshToken');

        console.log('AccessToken:', accessToken ? '있음' : '없음');
        console.log('RefreshToken:', refreshToken ? '있음' : '없음');

        if (!accessToken || !refreshToken) {
            redirectToLogin('로그인이 필요합니다.');
            return;
        }

        try {
            const payload = parseJwt(accessToken);
            userId = payload.sub;
            console.log('UserId 추출:', userId);
        } catch (e) {
            console.error('JWT 파싱 실패:', e);
            redirectToLogin('유효하지 않은 토큰입니다.');
            return;
        }

        try {
            console.log('토큰 검증 시작...');
            const response = await fetch('/v1/api/verify', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            console.log('검증 응답 상태:', response.status);

            if (response.ok) {
                const result = await response.json();
                console.log('검증 성공:', result);
                showMainContent(accessToken, refreshToken);
            } else if (response.status === 401) {
                console.log('토큰 만료, 재발급 시도...');
                const reissued = await attemptTokenReissue();

                if (reissued) {
                    showMainContent(
                        localStorage.getItem('accessToken'),
                        localStorage.getItem('refreshToken')
                    );
                } else {
                    redirectToLogin('세션이 만료되었습니다. 다시 로그인해주세요.');
                }
            } else {
                console.error('검증 실패:', response.status);
                redirectToLogin('인증에 실패했습니다.');
            }
        } catch (error) {
            console.error('인증 확인 에러:', error);
            // 네트워크 에러 시 일단 화면 표시
            showMainContent(accessToken, refreshToken);
        }
    }

    // 토큰 재발급 시도
    async function attemptTokenReissue() {
        const refreshToken = localStorage.getItem('refreshToken');
        console.log('토큰 재발급 시도 - UserId:', userId);

        try {
            const url = `/v1/auth/reissue?userId=${userId}&refreshToken=${encodeURIComponent(refreshToken)}`;
            console.log('재발급 URL:', url);

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });

            console.log('재발급 응답 상태:', response.status);
            const text = await response.text();
            console.log('재발급 응답:', text);

            if (!text) {
                console.error('서버 응답이 비어있습니다');
                return false;
            }

            const result = JSON.parse(text);

            if (result.code === "OK") {
                console.log('재발급 성공');
                localStorage.setItem('accessToken', result.data.accessToken);
                localStorage.setItem('refreshToken', result.data.refreshToken);
                return true;
            }
        } catch (error) {
            console.error('토큰 재발급 실패:', error);
        }

        return false;
    }

    // API 테스트
    async function testApi() {
        console.log('API 테스트 시작');
        const accessToken = localStorage.getItem('accessToken');

        try {
            const response = await fetch('/v1/api/test', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });

            console.log('API 테스트 응답 상태:', response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('API 테스트 성공:', data);
                alert('API 호출 성공!\n' + JSON.stringify(data, null, 2));
            } else if (response.status === 401) {
                console.log('토큰 만료됨');
                alert('토큰이 만료되었습니다. 재발급을 시도합니다.');
                const reissued = await reissueTokens();
                if (reissued) {
                    await testApi(); // 재시도
                }
            } else {
                console.error('API 호출 실패:', response.status);
                const errorText = await response.text();
                console.error('에러 내용:', errorText);
                alert('API 호출 실패: ' + response.status);
            }
        } catch (error) {
            console.error('API 호출 에러:', error);
            showError('API 호출 중 오류가 발생했습니다: ' + error.message);
        }
    }

    // 토큰 재발급
    async function reissueTokens() {
        console.log('토큰 재발급 버튼 클릭');

        if (!userId) {
            console.error('UserId 없음');
            showError('사용자 ID를 찾을 수 없습니다.');
            return false;
        }

        const refreshToken = localStorage.getItem('refreshToken');

        try {
            const url = `/v1/auth/reissue?userId=${userId}&refreshToken=${encodeURIComponent(refreshToken)}`;
            console.log('재발급 요청 URL:', url);

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });

            console.log('재발급 응답 상태:', response.status);
            const text = await response.text();
            console.log('재발급 응답 본문:', text);

            if (!text) {
                showError('서버 응답이 없습니다.');
                return false;
            }

            const result = JSON.parse(text);

            if (result.code === "OK") {
                localStorage.setItem('accessToken', result.data.accessToken);
                localStorage.setItem('refreshToken', result.data.refreshToken);

                document.getElementById('accessTokenDisplay').textContent = result.data.accessToken;
                document.getElementById('refreshTokenDisplay').textContent = result.data.refreshToken;

                alert('토큰이 재발급되었습니다!');
                return true;
            } else {
                showError(`토큰 재발급 실패: ${result.message}`);
                return false;
            }
        } catch (error) {
            console.error('토큰 재발급 에러:', error);
            showError('토큰 재발급 중 오류가 발생했습니다: ' + error.message);
            return false;
        }
    }

    // 로그아웃
    async function logout() {
        console.log('로그아웃 버튼 클릭');

        if (!userId) {
            console.error('UserId 없음');
            showError('사용자 ID를 찾을 수 없습니다.');
            return;
        }

        if (!confirm('정말 로그아웃 하시겠습니까?')) {
            return;
        }

        try {
            const url = `/v1/auth/logout?userId=${userId}`;
            console.log('로그아웃 URL:', url);

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });

            console.log('로그아웃 응답 상태:', response.status);
            const text = await response.text();
            console.log('로그아웃 응답 본문:', text);

            if (!text) {
                showError('서버 응답이 없습니다.');
                return;
            }

            const result = JSON.parse(text);

            if (result.code === "OK") {
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                alert('로그아웃 되었습니다.');
                window.location.href = '/v1/auth/login';
            } else {
                showError(`로그아웃 실패: ${result.message}`);
            }
        } catch (error) {
            console.error('로그아웃 에러:', error);
            showError('로그아웃 중 오류가 발생했습니다: ' + error.message);
        }
    }

    // 메인 화면 표시
    function showMainContent(accessToken, refreshToken) {
        console.log('메인 화면 표시');
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';

        document.getElementById('accessTokenDisplay').textContent = accessToken;
        document.getElementById('refreshTokenDisplay').textContent = refreshToken;

        const now = new Date();
        document.getElementById('loginTime').textContent = now.toLocaleString('ko-KR');
        document.getElementById('userIdDisplay').textContent = userId;
    }

    // 로그인 페이지로 리다이렉트
    function redirectToLogin(message) {
        console.log('로그인 페이지로 리다이렉트:', message);
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        alert(message);
        window.location.href = '/v1/auth/login';
    }

    // JWT 디코딩
    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    }

    // 에러 메시지 표시
    function showError(message) {
        console.error('에러:', message);
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
</script>
</body>
</html>