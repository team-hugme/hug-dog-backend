<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>User ๋ก๊ทธ์ธ ํ ํ๋ฉด</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="main-container" id="mainContent" style="display: none;">
  <div class="welcome-section">
    <p>ํ์ํฉ๋๋ค!</p>
    <span class="status-badge status-active">๋ก๊ทธ์ธ ์ค</span>
  </div>

  <div class="user-info">
    <h3>๐ ์ฌ์ฉ์ ์๋ณด</h3>
    <div class="info-item">
      <strong>์ฌ์ฉ์ ID:</strong>
      <span id="userIdDisplay">๋ก๋ฉ ์ค...</span>
    </div>
    <div class="info-item">
      <strong>๋ก๊ทธ์ธ ์๊ฐ:</strong>
      <span id="loginTime"></span>
    </div>
  </div>

  <div class="action-buttons">
    <button class="btn btn-danger" onclick="logout()">๋ก๊ทธ์์</button>
  </div>

  <div id="errorMessage"></div>
</div>
<script th:src="@{/js/auth.js}"></script>
<script defer th:inline="javascript">
  const DEV_DOMAIN = [[${devDomain}]];
  let userId = null;

  window.onload = async function () {
    AuthManager.startAutoRefresh();
    await checkAuthentication();
  };

  async function checkAuthentication() {
    let accessToken = localStorage.getItem('accessToken');

    if (!accessToken) {
      return redirectToLogin('๋ก๊ทธ์ธ์ด ํ์ํฉ๋๋ค.');
    }
    try {
      userId = parseJwt(accessToken).sub;
    } catch {
      return redirectToLogin('์ํจํ์ง ์์ ํํฐ์๋๋ค.');
    }
    // ์ต์ข ํํฐ ๊ฐ์ธ์ค๊ธฐ
    accessToken = localStorage.getItem('accessToken');
    showMainContent(accessToken);
  }

  async function logout() {
    if (!confirm('๋ก๊ทธ์์ ํ์๊ฒ์ต๋๊น?')) {
      return;
    }

    try {
      const res = await fetch(`${DEV_DOMAIN}/api/v1/auth/logout`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        credentials: 'include'
      });
      const result = await res.json();
      if (res.ok) {
        localStorage.clear();
        alert('๋ก๊ทธ์์ ์๋ฃ');
        window.location.href = '/view/login';
      } else {
        showError(`๋ก๊ทธ์์ ์คํจ: ${result.message || '์ ์ ์๋ ์ค๋ฅ'}`);
      }
    } catch (err) {
      console.error(err);
      showError('๋ก๊ทธ์์ ์ค๋ฅ: ' + err.message);
    }
  }

  function showMainContent(accessToken) {
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('loginTime').textContent = new Date().toLocaleString('ko-KR');
    document.getElementById('userIdDisplay').textContent = userId;
  }

  // JWT ํ์ฑ
  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join('')));
  }

  // ์๋ฌ / ๋ก๊ทธ์ธ ๋ฆฌ๋ค์ด๋ํธ
  function showError(msg) {
    const div = document.getElementById('errorMessage');
    div.textContent = msg;
    div.style.display = 'block';
    setTimeout(() => div.style.display = 'none', 5000);
  }

  function redirectToLogin(msg) {
    localStorage.clear();
    alert(msg);
    window.location.href = '/view/login';
  }
</script>
</body>
</html>
