<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>User ๋ก๊ทธ์ธ ํ ํ๋ฉด</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="main-container" id="mainContent" style="display: none;">
  <div class="welcome-section">
    <p>ํ์ํฉ๋๋ค!</p>
    <span class="status-badge status-active">๋ก๊ทธ์ธ ์ค</span>
  </div>

  <div class="user-info">
    <h3>๐ ์ฌ์ฉ์ ์๋ณด</h3>
    <div class="info-item">
      <strong>์ฌ์ฉ์ ID:</strong>
      <span id="userIdDisplay">๋ก๋ฉ ์ค...</span>
    </div>
    <div class="info-item">
      <strong>๋ก๊ทธ์ธ ์๊ฐ:</strong>
      <span id="loginTime"></span>
    </div>
  </div>

  <div class="token-section">
    <h4>๐ Access Token</h4>
    <div class="token-display" id="accessTokenDisplay">ํํฐ ๋ก๋ฉ ์ค...</div>
  </div>

  <div class="token-section" style="border-left-color: #2196f3; background: #e3f2fd;">
    <h4 style="color: #1565c0;">๐ Refresh Token</h4>
    <div class="token-display" id="refreshTokenDisplay">ํํฐ ๋ก๋ฉ ์ค...</div>
  </div>

  <div class="action-buttons">
    <button class="btn btn-danger" onclick="logout()">๋ก๊ทธ์์</button>
  </div>

  <div id="errorMessage"></div>
</div>

<div class="loading" id="loadingMessage">
  <h2>๐ ์ธ์ฆ ํ์ธ ์ค...</h2>
  <p>์์๋ง ๊ธฐ๋ค๋ค์ฃผ์ธ์.</p>
</div>

<script th:inline="javascript">
  const DEV_DOMAIN = [[${devDomain}]];
  let userId = null;

  // -------------------------------
  // ํ์ด์ง ๋ก๋ ์ ์๋ ์ธ์ฆ ํ์ธ & ํํฐ ์ฌ๋ฐ๊ธ
  // -------------------------------
  window.onload = async function () {
    await checkAuthentication();
  };

  async function checkAuthentication() {
    let accessToken = localStorage.getItem('accessToken');
    let refreshToken = localStorage.getItem('refreshToken');

    if (!accessToken || !refreshToken) {
      return redirectToLogin('๋ก๊ทธ์ธ์ด ํ์ํฉ๋๋ค.');
    }

    try {
      userId = parseJwt(accessToken).sub;
    } catch {
      return redirectToLogin('์ํจํ์ง ์์ ํํฐ์๋๋ค.');
    }

    // Access Token ๊ฒ์ฆ
    const verified = await verifyAccessToken(accessToken);
    if (!verified) {
      // Access Token ์ฌ๋ฐ๊ธ
      const accessSuccess = await reissueAccessToken();
      if (!accessSuccess) {
        // Refresh Token ์ฌ๋ฐ๊ธ
        const refreshSuccess = await reissueRefreshToken();
        if (!refreshSuccess) {
          return redirectToLogin('์ธ์ ๋ง๋ฃ. ๋ค์ ๋ก๊ทธ์ธ ํ์');
        }
      }
    }

    // ์ต์ข ํํฐ ๊ฐ์ธ์ค๊ธฐ
    accessToken = localStorage.getItem('accessToken');
    refreshToken = localStorage.getItem('refreshToken');
    showMainContent(accessToken, refreshToken);
  }

  // -------------------------------
  // Access Token ๊ฒ์ฆ
  // -------------------------------
  async function verifyAccessToken(token) {
    try {
      const res = await fetch(`${DEV_DOMAIN}/api/v1/auth/verify`, {
        method: 'GET',
        headers: {'Authorization': `Bearer ${token}`}
      });
      return res.ok;
    } catch {
      return false;
    }
  }

  // -------------------------------
  // Access Token ์ฌ๋ฐ๊ธ
  // -------------------------------
  async function reissueAccessToken() {
    try {
      const res = await fetch(`${DEV_DOMAIN}/api/v1/auth/reissue/access`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId})
      });
      const result = await res.json();
      if (result.status === "201") {
        localStorage.setItem('accessToken', result.data.accessToken);
        return true;
      }
      return false;
    } catch {
      return false;
    }
  }

  // -------------------------------
  // Refresh Token ์ฌ๋ฐ๊ธ
  // -------------------------------
  async function reissueRefreshToken() {
    const refreshToken = localStorage.getItem('refreshToken');
    if (!refreshToken) {
      return false;
    }

    try {
      const res = await fetch(`${DEV_DOMAIN}/api/v1/auth/reissue/refresh`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({userId, refreshToken})
      });
      const result = await res.json();
      if (result.status === "201") {
        localStorage.setItem('accessToken', result.data.accessToken);
        localStorage.setItem('refreshToken', result.data.refreshToken);
        return true;
      }
      return false;
    } catch {
      return false;
    }
  }

  async function logout() {
    if (!confirm('๋ก๊ทธ์์ ํ์๊ฒ์ต๋๊น?')) {
      return;
    }

    try {
      const res = await fetch(`${DEV_DOMAIN}/api/v1/auth/logout`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('accessToken')}`,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
        // body ์์!
      });

      const result = await res.json();

      if (res.ok && result.code === "NO_CONTENT") {
        localStorage.clear();
        alert('๋ก๊ทธ์์ ์๋ฃ');
        window.location.href = '/view/login';
      } else {
        showError(`๋ก๊ทธ์์ ์คํจ: ${result.message || '์ ์ ์๋ ์ค๋ฅ'}`);
      }
    } catch (err) {
      console.error(err);
      showError('๋ก๊ทธ์์ ์ค๋ฅ: ' + err.message);
    }
  }

  // -------------------------------
  // ํ๋ฉด ํ์
  // -------------------------------
  function showMainContent(accessToken, refreshToken) {
    document.getElementById('loadingMessage').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    document.getElementById('accessTokenDisplay').textContent = accessToken;
    document.getElementById('refreshTokenDisplay').textContent = refreshToken;
    document.getElementById('loginTime').textContent = new Date().toLocaleString('ko-KR');
    document.getElementById('userIdDisplay').textContent = userId;
  }

  // -------------------------------
  // JWT ํ์ฑ
  // -------------------------------
  function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(decodeURIComponent(atob(base64).split('').map(c =>
        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
    ).join('')));
  }

  // -------------------------------
  // ์๋ฌ / ๋ก๊ทธ์ธ ๋ฆฌ๋ค์ด๋ํธ
  // -------------------------------
  function showError(msg) {
    const div = document.getElementById('errorMessage');
    div.textContent = msg;
    div.style.display = 'block';
    setTimeout(() => div.style.display = 'none', 5000);
  }

  function redirectToLogin(msg) {
    localStorage.clear();
    alert(msg);
    window.location.href = '/view/login';
  }
</script>
</body>
</html>
